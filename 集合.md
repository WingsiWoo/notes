# é›†åˆ

## ArrayList

`ArrayList`å®ç°äº†`List`æ¥å£ï¼Œæ˜¯é¡ºåºå®¹å™¨ï¼Œå³å…ƒç´ å­˜æ”¾çš„æ•°æ®ä¸æ”¾è¿›å»çš„é¡ºåºç›¸åŒï¼Œå…è®¸æ”¾å…¥`null`å…ƒç´ ï¼Œåº•å±‚é€šè¿‡**æ•°ç»„å®ç°**ã€‚é™¤è¯¥ç±»æœªå®ç°åŒæ­¥å¤–ï¼Œå…¶ä½™è·Ÿ`Vector`å¤§è‡´ç›¸åŒã€‚æ¯ä¸ª`ArrayList`éƒ½æœ‰ä¸€ä¸ªå®¹é‡(`capacity`)ï¼Œè¡¨ç¤ºåº•å±‚æ•°ç»„çš„å®é™…å¤§å°ï¼Œå®¹å™¨å†…å­˜å‚¨å…ƒç´ çš„ä¸ªæ•°ä¸èƒ½å¤šäºå½“å‰å®¹é‡ã€‚å½“å‘å®¹å™¨ä¸­æ·»åŠ å…ƒç´ æ—¶ï¼Œå¦‚æœå®¹é‡ä¸è¶³ï¼Œå®¹å™¨ä¼šè‡ªåŠ¨å¢å¤§åº•å±‚æ•°ç»„çš„å¤§å°ã€‚å‰é¢å·²ç»æè¿‡ï¼ŒJavaæ³›å‹åªæ˜¯ç¼–è¯‘å™¨æä¾›çš„è¯­æ³•ç³–ï¼Œæ‰€ä»¥è¿™é‡Œçš„æ•°ç»„æ˜¯ä¸€ä¸ªObjectæ•°ç»„ï¼Œä»¥ä¾¿èƒ½å¤Ÿå®¹çº³ä»»ä½•ç±»å‹çš„å¯¹è±¡ã€‚

`size(),` `isEmpty()`, `get(),` `set()`æ–¹æ³•å‡èƒ½åœ¨å¸¸æ•°æ—¶é—´å†…å®Œæˆï¼Œ`add()`æ–¹æ³•çš„æ—¶é—´å¼€é”€è·Ÿæ’å…¥ä½ç½®æœ‰å…³ï¼Œ`addAll()`æ–¹æ³•çš„æ—¶é—´å¼€é”€è·Ÿæ·»åŠ å…ƒç´ çš„ä¸ªæ•°æˆæ­£æ¯”ã€‚å…¶ä½™æ–¹æ³•å¤§éƒ½æ˜¯çº¿æ€§æ—¶é—´ã€‚

ä¸ºè¿½æ±‚æ•ˆç‡ï¼Œ`ArrayList`æ²¡æœ‰å®ç°åŒæ­¥(synchronized)ï¼Œå¦‚æœéœ€è¦å¤šä¸ªçº¿ç¨‹å¹¶å‘è®¿é—®ï¼Œç”¨æˆ·å¯ä»¥æ‰‹åŠ¨åŒæ­¥ï¼Œä¹Ÿå¯ä½¿ç”¨`Vector`æ›¿ä»£ã€‚



### å±æ€§åˆ†æ

```java
// é»˜è®¤çš„åˆå§‹å®¹é‡
private static final int DEFAULT_CAPACITY = 10;

private static final Object[] EMPTY_ELEMENTDATA = {};

private static final Object[] DEFAULTCAPACITY_EMPTY_ELEMENTDATA = {};

// ç”¨äºå­˜å‚¨æ•°æ®çš„æ•°ç»„
transient Object[] elementData; 

// æ•°ç»„å¤§å°
private int size;
```

1. `EMPTY_ELEMENTDATA`å’Œ`DEFAULTCAPACITY_EMPTY_ELEMENTDATA`ï¼ˆä»¥ä¸‹ç®€ç§°ä¸º`EE`å’Œ`DEE`ï¼‰

   è¿™ä¸¤ä¸ªå®é™…ä¸Šéƒ½æ˜¯å…±äº«ç©ºæ•°ç»„ï¼Œåªæ˜¯åå­—ä¸ä¸€æ ·è€Œå·²ã€‚

   - è°ƒç”¨æ— å‚æ„é€ å™¨åˆ›å»ºçš„å®ä¾‹æ˜¯DEEï¼Œè°ƒç”¨æœ‰å‚æ„é€ å™¨ï¼ˆå‚æ•°ä¸º0ï¼‰åˆ›å»ºçš„å®ä¾‹æ˜¯EE

   - åœ¨`add(E e)`æ–¹æ³•ä¸­ï¼Œä¼šå…ˆåˆ¤æ–­`elementData == DEE`ï¼Œå¦‚æœä¸º`true`ï¼Œè¯´æ˜è¿™ä¸ª`ArrayList`æ˜¯è°ƒç”¨æ— å‚æ„é€ å™¨åˆ›å»ºçš„ï¼Œé‚£ä¹ˆå°±ä¼šç›´æ¥æ‰©å®¹åˆ°é»˜è®¤çš„æœ€å°åˆå§‹å®¹é‡`DEFAULT_CAPACITYï¼ˆ10ï¼‰`

     å¦‚æœä¸ä¸º`true`ï¼Œè¯´æ˜è¿™ä¸ª`ArrayList`æ˜¯è°ƒç”¨æœ‰å‚æ„é€ å™¨åˆ›å»ºçš„ç©ºå®ä¾‹ï¼Œå®ƒçš„å®¹é‡å¢é•¿æ˜¯è¿™æ ·çš„ï¼š1â†’2â†’3â†’4â†’5â†’6â†’7â†’8â†’9â†’13ï¼ˆ9â†’13çš„å¢é•¿è§„å¾‹åœ¨ä¹‹åè®²è§£`grow()`æ–¹æ³•æ—¶ç»†ğŸ”ï¼‰

   - `EE`çš„å­˜åœ¨æ˜¯ä¸ºäº†ä¼˜åŒ–åˆ›å»º`ArrayList`ç©ºå®ä¾‹æ—¶äº§ç”Ÿä¸å¿…è¦çš„ç©ºæ•°ç»„ï¼šåœ¨æ·»åŠ ç¬¬ä¸€ä¸ªå…ƒç´ å‰æ‰€æœ‰`ArrayList`ç©ºå®ä¾‹éƒ½æŒ‡å‘`EE`è¿™ä¸ªç©ºæ•°ç»„ï¼ŒèŠ‚çœäº†å¤§é‡çš„å†…å­˜ç©ºé—´

   - `DEE`æ˜¯ä¸ºäº†ç¡®ä¿æ— å‚æ„é€ å™¨åˆ›å»ºçš„å®ä¾‹åœ¨æ·»åŠ ç¬¬ä¸€ä¸ªå…ƒç´ æ—¶ï¼Œæœ€å°çš„å®¹é‡ä¸ºé»˜è®¤å¤§å°10ï¼Œé¿å…å‡ºç°åƒ`EE`é‚£æ ·å®¹é‡ç¼“æ…¢å¢é•¿éœ€è¦å¤šæ¬¡æ‰©å®¹çš„æƒ…å†µã€‚é’ˆå¯¹æœ‰å‚æ— å‚çš„æ„é€ åœ¨æ‰©å®¹æ—¶åšåŒºåˆ†èµ°ä¸é€šçš„æ‰©å®¹é€»è¾‘ï¼Œä¼˜åŒ–æ€§èƒ½ã€‚

   - `Java8`ä¸­æ‰æ·»åŠ äº†`DEE`ï¼Œåœ¨`Java7`åŠä¹‹å‰ä¹‹æœ‰EE`è¡¨ç¤º`ç©ºæ•°ç»„

2. `ArrayList`åº•å±‚ä¸­ä½¿ç”¨`Object[]`æ•°ç»„æ¥å­˜å‚¨æ•°æ®ã€‚

   **ä¸ºä»€ä¹ˆä½¿ç”¨transientä¿®é¥°ï¼Ÿ**

   é¦–å…ˆè¦è¯´æ˜`transient`çš„ä½œç”¨ï¼š  `transient`ç”¨æ¥è¡¨ç¤ºä¸€ä¸ªåŸŸä¸æ˜¯è¯¥å¯¹è±¡åºè¡ŒåŒ–çš„ä¸€éƒ¨åˆ†ï¼Œå½“ä¸€ä¸ªå¯¹è±¡è¢«åºè¡ŒåŒ–çš„æ—¶å€™ï¼Œ`transient`ä¿®é¥°çš„å˜é‡çš„å€¼æ˜¯ä¸åŒ…æ‹¬åœ¨åºè¡ŒåŒ–çš„è¡¨ç¤ºä¸­çš„ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œ`ArrayList`åºåˆ—åŒ–åæ˜¯æ²¡æœ‰`elementData`çš„ã€‚

   **é‚£è¿™æ ·åºåˆ—åŒ–åæ•°æ®å²‚ä¸æ˜¯ä¸¢å¤±äº†ï¼Ÿ**

   å…¶å®`ArrayList`ä¸­æä¾›äº†ä¸¤ä¸ªæ–¹æ³•ä¸“é—¨ç”¨æ¥å¯¹`elementData`åºåˆ—åŒ–å’Œååºåˆ—åŒ–ï¼š`writeObject()`å’Œ`readObject()`ã€‚

   > `ArrayList`åœ¨åºåˆ—åŒ–çš„æ—¶å€™ä¼šè°ƒç”¨`writeObject`ï¼Œç›´æ¥å°†`size`å’Œ`element`å†™å…¥`ObjectOutputStream`ï¼›
   >
   > ååºåˆ—åŒ–æ—¶è°ƒç”¨`readObject`ï¼Œä»`ObjectInputStream`è·å–`size`å’Œ`element`ï¼Œå†æ¢å¤åˆ°`elementData`ã€‚

   **ä¸ºä»€ä¹ˆå¯¹äºelementDataä¸ç›´æ¥åºåˆ—åŒ–è€Œè¦ä½¿ç”¨ä¸Šè¿°çš„æ–¹æ³•ï¼Ÿ**

   `elementData`æ˜¯ä¸€ä¸ªç¼“å­˜æ•°ç»„ï¼Œå®ƒé€šå¸¸ä¼šé¢„ç•™ä¸€äº›ç©ºé—´æ¥å­˜å‚¨æ–°çš„å…ƒç´ ï¼Œä¹Ÿå°±æ˜¯è¯´`elementData`ä¸­çš„éƒ¨åˆ†ç©ºé—´å¯èƒ½æ˜¯æ²¡æœ‰å®é™…å­˜å‚¨å…ƒç´ çš„ï¼Œå¦‚æœé‡‡ç”¨ä¸Šè¿°ä¸¤ä¸ªæ–¹æ³•è¿›è¡Œåºåˆ—åŒ–ï¼Œå°±å¯ä»¥ä¿è¯åªå®ä¾‹åŒ–é‚£äº›å®é™…å­˜å‚¨çš„å…ƒç´ ï¼Œè€Œä¸æ˜¯æ•´ä¸ªæ•°ç»„ï¼Œä»è€ŒèŠ‚çœç©ºé—´å’Œæ—¶é—´ã€‚



### è‡ªåŠ¨æ‰©å®¹

#### æ£€æŸ¥æ˜¯å¦éœ€è¦æ‰©å®¹â€“è°ƒæ•´minCapacityçš„å€¼

åœ¨è°ƒç”¨`add(E e)`æ–¹æ³•æ’å…¥å…ƒç´ æ—¶ï¼Œä¼šå…ˆè°ƒç”¨`ensureCapacityInternal(size + 1)`æ¥æ£€æŸ¥æ˜¯å¦éœ€è¦ç»™æ•°æ®æ‰©å®¹ã€‚

```java
// minCapacityå³size+1
private void ensureCapacityInternal(int minCapacity) {
  	ensureExplicitCapacity(calculateCapacity(elementData, minCapacity));
}

private static int calculateCapacity(Object[] elementData, int minCapacity) {
    if (elementData == DEFAULTCAPACITY_EMPTY_ELEMENTDATA) {
      return Math.max(DEFAULT_CAPACITY, minCapacity);
    }
    return minCapacity;
}

private void ensureExplicitCapacity(int minCapacity) {
    modCount++;

    // overflow-conscious code
    if (minCapacity - elementData.length > 0)
      grow(minCapacity);
}
```

1. åœ¨`calculateCapacity`æ–¹æ³•ä¸­ï¼Œä¼šå…ˆåˆ¤æ–­`elementData == DEFAULTCAPACITY_EMPTY_ELEMENTDATA`ï¼Œå¦‚æœä¸º`true`ï¼Œå°±è¿”å›`DEFAULT_CAPACITY`å’Œ`minCapacity`ä¸­çš„è¾ƒå¤§è€…ï¼Œå¦åˆ™ç›´æ¥è¿”å›`minCapacity`

   > æ‰€ä»¥å‰é¢è¯´è°ƒç”¨`add(E e)`æ–¹æ³•æ·»åŠ ç¬¬ä¸€ä¸ªå…ƒç´ æ—¶ï¼Œå¯¹`DEE`ä¼šç›´æ¥æ‰©å®¹åˆ°10ï¼ˆå› ä¸ºæ­¤æ—¶`minCapacity`ä¸º1ï¼Œä¸€å®šæ¯”`DEFAULT_CAPACITY`å°ï¼‰ï¼›è€Œå¯¹`EE`åªä¼šæ‰©å¤§1ï¼ˆç›´æ¥è¿”å›`minCapacity`ï¼‰

2. `ensureExplicitCapacity`ä¸­ä½¿ç”¨åˆ°çš„`modCount`æ˜¯ç»§æ‰¿è‡ª`AbstractList`çš„æˆå‘˜å˜é‡ï¼Œå®ƒè®°å½•ç€é›†åˆä¿®æ”¹çš„æ¬¡æ•°ï¼Œä¹Ÿå°±æ˜¯è¯´æ¯æ¬¡`add`æˆ–`remove`ç­‰æ—¶éƒ½ä¼š`modCount++`ã€‚

   åœ¨å¯¹ä¸€ä¸ªé›†åˆå¯¹è±¡è¿›è¡Œè¿­ä»£æ—¶ï¼Œå¹¶ä¸ä¼šå†™é™åˆ¶å¯¹é›†åˆæ“ä½œçš„æ–¹æ³•ã€‚ä½†å¦‚æœåœ¨è¿­ä»£è¿‡ç¨‹ä¸­è°ƒç”¨`add`ã€`remove`è¿™ç§ä¼šå½±å“é›†åˆæ•°æ®çš„æ–¹æ³•ï¼Œå¯èƒ½ä¼šå½±å“è¿­ä»£ä¸­çš„æ•°æ®æ··ä¹±ä»è€Œå¼•èµ·é”™è¯¯ã€‚æˆ‘ä»¬å¸Œæœ›æä¾›ä¸€ç§å¿«å¤±è´¥æœºåˆ¶ï¼Œå°½æœ€å¤§å¯èƒ½å»æŠ›å‡ºå¼‚å¸¸å»é¿å…è¿™æ ·çš„æƒ…å†µå‡ºç°ã€‚

   å› æ­¤ä½¿ç”¨äº†`modCount`ï¼Œè¿­ä»£å™¨ä¸­æœ‰ä¸€ä¸ªå±æ€§ä¸º`expectedModCount`ï¼Œå®ƒçš„åˆå§‹å€¼å°±æ˜¯`modCount`ã€‚åœ¨è°ƒç”¨åƒ`add`ã€`remove`è¿™ç±»æ–¹æ³•å‰ä¼šå…ˆè°ƒç”¨`checkForComodification()`æ¥æ£€æŸ¥`expectedModCount`å’Œ`modCount`æ˜¯å¦ç›¸ç­‰ï¼Œå¦‚æœä¸ç›¸ç­‰åˆ™æŠ›å‡º`ConcurrentModificationException`å¼‚å¸¸

   > å¦‚æœæ²¡`checkForComodification`å»æ£€æŸ¥`expectedModCount`ä¸`modCount`ç›¸ç­‰ï¼Œè¿™ä¸ªç¨‹åºè‚¯å®šä¼šæŠ¥`ArrayIndexOutOfBoundsException`ï¼Œè¿™æ˜¾ç„¶æ˜¯ä¸ç¬¦åˆé€»è¾‘çš„ã€‚

3. å¦‚æœæœ€å°éœ€è¦ç©ºé—´`minCapacity > elementData`çš„é•¿åº¦ï¼Œè¯´æ˜éœ€è¦æ‰©å®¹ï¼Œè°ƒç”¨`grow`æ–¹æ³•æ‰©å®¹åˆ°`minCapacity`



#### æ‰©å®¹

æ•°ç»„æ¯æ¬¡æ‰©å®¹ä¼šæ‰©å±•æˆåŸå®¹é‡çš„**1.5å€**ï¼Œç„¶åå†æ ¹æ®`minCapacity`çš„å€¼å»åšç›¸å…³æ“ä½œã€‚æ‰€ä»¥å‰é¢æåŠåˆ°çš„9â†’13å°±æ˜¯9+9/2=13

```java
private static final int MAX_ARRAY_SIZE = Integer.MAX_VALUE - 8;

private void grow(int minCapacity) {
    // æ‰©å®¹å‰æ•°ç»„çš„é•¿åº¦
    int oldCapacity = elementData.length;
   // æ–°å®¹é‡ä¸ºæ—§å®¹é‡çš„1.5å€
    int newCapacity = oldCapacity + (oldCapacity >> 1);
  // å¦‚æœæ‰©å®¹åä»ç„¶æ¯”æ‰€éœ€ç©ºé—´å°ï¼Œå°±æŠŠæ•°ç»„é•¿åº¦ç›´æ¥è®¾ç½®ä¸ºéœ€è¦çš„é•¿åº¦
    if (newCapacity - minCapacity < 0)
        newCapacity = minCapacity;
  // åˆ¤æ–­æ•°ç»„é•¿åº¦æ˜¯å¦æº¢å‡º
    if (newCapacity - MAX_ARRAY_SIZE > 0)
        newCapacity = hugeCapacity(minCapacity);
    // å¦‚æœæ‰©å®¹åç©ºé—´è¶³å¤Ÿäº†ï¼Œå°±åˆ›å»ºæ–°çš„æ•°ç»„å°±å¯ä»¥äº†
    elementData = Arrays.copyOf(elementData, newCapacity);
}

// ç”¨äºå¤„ç†æ•°ç»„é•¿åº¦æº¢å‡ºçš„æƒ…å†µ
private static int hugeCapacity(int minCapacity) {
    if (minCapacity < 0) // overflow
        throw new OutOfMemoryError();
  // å¦‚æœæ‰€éœ€ç©ºé—´ä¹Ÿæº¢å‡ºåˆ™æ–°æ•°ç»„é•¿åº¦ä¸ºMAX_VALUEï¼Œå¦åˆ™ä¸ºé»˜è®¤çš„æœ€å¤§çš„æ•°ç»„é•¿åº¦
    return (minCapacity > MAX_ARRAY_SIZE) ?
        Integer.MAX_VALUE :
        MAX_ARRAY_SIZE;
}
```

<img src="https://tva1.sinaimg.cn/large/008i3skNgy1gwkhttt6l7j30u01d1wkt.jpg" alt="image-20211119153122874" style="zoom:67%;" />



### remove

`remove()`æ–¹æ³•ä¹Ÿæœ‰ä¸¤ä¸ªç‰ˆæœ¬ï¼Œä¸€ä¸ªæ˜¯`remove(int index)`åˆ é™¤æŒ‡å®šä½ç½®çš„å…ƒç´ ï¼Œå¦ä¸€ä¸ªæ˜¯`remove(Object o)`åˆ é™¤ç¬¬ä¸€ä¸ªæ»¡è¶³`o.equals(elementData[index])`çš„å…ƒç´ ã€‚åˆ é™¤æ“ä½œæ˜¯`add()`æ“ä½œçš„é€†è¿‡ç¨‹ï¼Œéœ€è¦å°†åˆ é™¤ç‚¹ä¹‹åçš„å…ƒç´ å‘å‰ç§»åŠ¨ä¸€ä¸ªä½ç½®ã€‚**éœ€è¦æ³¨æ„çš„æ˜¯ä¸ºäº†è®©GCèµ·ä½œç”¨ï¼Œå¿…é¡»æ˜¾å¼çš„ä¸ºæœ€åä¸€ä¸ªä½ç½®èµ‹`null`å€¼ã€‚**

```java
public E remove(int index) {
    rangeCheck(index);
    modCount++;
    E oldValue = elementData(index);
    int numMoved = size - index - 1;
    if (numMoved > 0)
        System.arraycopy(elementData, index+1, elementData, index, numMoved);
    elementData[--size] = null; //æ¸…é™¤è¯¥ä½ç½®çš„å¼•ç”¨ï¼Œè®©GCèµ·ä½œç”¨
    return oldValue;
}
    
```

> å…³äºJava GCè¿™é‡Œéœ€è¦ç‰¹åˆ«è¯´æ˜ä¸€ä¸‹ï¼Œ**æœ‰äº†åƒåœ¾æ”¶é›†å™¨å¹¶ä¸æ„å‘³ç€ä¸€å®šä¸ä¼šæœ‰å†…å­˜æ³„æ¼**ã€‚å¯¹è±¡èƒ½å¦è¢«GCçš„ä¾æ®æ˜¯æ˜¯å¦è¿˜æœ‰å¼•ç”¨æŒ‡å‘å®ƒï¼Œä¸Šé¢ä»£ç ä¸­å¦‚æœä¸æ‰‹åŠ¨èµ‹`null`å€¼ï¼Œé™¤éå¯¹åº”çš„ä½ç½®è¢«å…¶ä»–å…ƒç´ è¦†ç›–ï¼Œå¦åˆ™åŸæ¥çš„å¯¹è±¡å°±ä¸€ç›´ä¸ä¼šè¢«å›æ”¶ã€‚



### toArrayå¼‚å¸¸

`ArrayList`æä¾›ä¸¤ä¸ªè½¬æ¢æˆæ•°ç»„çš„æ–¹æ³•

```java
Object[] toArray()
<T> T[] toArray(T[] a)
```

å¦‚æœè°ƒç”¨`toArray()`æ–¹æ³•å¯èƒ½ä¼šæŠ›å‡º`ClassCastException`å¼‚å¸¸ï¼Œä½†è°ƒç”¨`toArray(T[] a)`åˆ™ä¸ä¼šã€‚è¿™æ˜¯å› ä¸º`toArray()`æ–¹æ³•è¿”å›`Object[]`æ•°ç»„ï¼Œå°†`Object[]`è½¬æ¢æˆå…¶ä»–ç±»å‹å¯èƒ½ä¼šå¼•èµ·å¼‚å¸¸ï¼Œå› ä¸ºJavaä¸æ”¯æŒå‘ä¸‹è½¬å‹



## Stack&Queue

**ä¸ºä»€ä¹ˆç°åœ¨å®˜æ–¹ä¸æ¨èä½¿ç”¨Stackå®ç°æ ˆï¼Ÿ**

Stackç»§æ‰¿äº†Vectorç±»ï¼Œä¸€ç‚¹æ˜¯ç°åœ¨å®˜æ–¹ä¹Ÿä¸æ¨èä½¿ç”¨Vectorã€‚

å¦ä¸€ç‚¹æ˜¯Vectoræ˜¯åŠ¨æ€æ•°ç»„ï¼Œè¿™æ„å‘³ç€å®ƒå¯ä»¥åœ¨æ•°ç»„ä¸­ä»»æ„ä½ç½®æ·»åŠ å’Œåˆ é™¤å…ƒç´ ï¼ŒStackç»§æ‰¿äº†Vectorä¸­æ‰€æœ‰çš„å…¬æœ‰æ–¹æ³•ï¼Œè€Œæ ˆåªèƒ½å¯¹æ ˆé¡¶å…ƒç´ è¿›è¡Œæ“ä½œï¼Œå› æ­¤è¿™æ ·çš„è®¾è®¡ç ´åäº†å¯¹æ ˆçš„æ•°æ®ç»“æ„çš„å°è£…ã€‚



### Queue

`Queue`æ¥å£ç»§æ‰¿è‡ª`Collection`æ¥å£ï¼Œé™¤äº†æœ€åŸºæœ¬çš„`Collection`çš„æ–¹æ³•ä¹‹å¤–ï¼Œå®ƒè¿˜æ”¯æŒé¢å¤–çš„*`insertion`*, *`extraction`*å’Œ*`inspection`*æ“ä½œã€‚è¿™é‡Œæœ‰ä¸¤ç»„æ ¼å¼ï¼Œå…±6ä¸ªæ–¹æ³•ï¼Œä¸€ç»„æ˜¯æŠ›å‡ºå¼‚å¸¸çš„å®ç°ï¼›å¦å¤–ä¸€ç»„æ˜¯è¿”å›å€¼çš„å®ç°(æ²¡æœ‰åˆ™è¿”å›`null`)ã€‚

|         | Throws exception | Returns special value |
| :-----: | :--------------: | :-------------------: |
| Insert  |      add(e)      |       offer(e)        |
| Remove  |     remove()     |        poll()         |
| Examine |    element()     |        peek()         |



### Deque

`Deque`æ˜¯"double ended queue", è¡¨ç¤ºåŒå‘çš„é˜Ÿåˆ—ï¼Œè‹±æ–‡è¯»ä½œ"deck". Deque ç»§æ‰¿è‡ª Queueæ¥å£ï¼Œé™¤äº†æ”¯æŒQueueçš„æ–¹æ³•ä¹‹å¤–ï¼Œè¿˜æ”¯æŒ`insert`, `remove`å’Œ`examine`æ“ä½œï¼Œç”±äºDequeæ˜¯åŒå‘çš„ï¼Œæ‰€ä»¥å¯ä»¥å¯¹é˜Ÿåˆ—çš„å¤´å’Œå°¾éƒ½è¿›è¡Œæ“ä½œï¼Œå®ƒåŒæ—¶ä¹Ÿæ”¯æŒä¸¤ç»„æ ¼å¼ï¼Œä¸€ç»„æ˜¯æŠ›å‡ºå¼‚å¸¸çš„å®ç°ï¼›å¦å¤–ä¸€ç»„æ˜¯è¿”å›å€¼çš„å®ç°(æ²¡æœ‰åˆ™è¿”å›null)ã€‚å…±12ä¸ªæ–¹æ³•å¦‚ä¸‹:

|         | First Element - Head |               | Last Element - Tail |               |
| :-----: | :------------------: | :-----------: | :-----------------: | :-----------: |
|         |   Throws exception   | Special value |  Throws exception   | Special value |
| Insert  |     addFirst(e)      | offerFirst(e) |     addLast(e)      | offerLast(e)  |
| Remove  |    removeFirst()     |  pollFirst()  |    removeLast()     |  pollLast()   |
| Examine |      getFirst()      |  peekFirst()  |      getLast()      |  peekLast()   |



#### ArrayDeque

`ArrayDeque`å’Œ`LinkedList`æ˜¯`Deque`çš„ä¸¤ä¸ªé€šç”¨å®ç°ï¼Œå®˜æ–¹æ›´æ¨èä½¿ç”¨`AarryDeque`ç”¨ä½œæ ˆå’Œé˜Ÿåˆ—

`ArrayDeque`åº•å±‚ä½¿ç”¨æ•°ç»„å®ç°ï¼Œä¸ºäº†èƒ½æ»¡è¶³å¯ä»¥åœ¨æ•°ç»„ä¸¤ç«¯åŒæ—¶æ’å…¥æˆ–åˆ é™¤å…ƒç´ çš„éœ€æ±‚ï¼Œè¯¥æ•°ç»„åº”è¯¥æ˜¯ä¸€ä¸ª**å¾ªç¯æ•°ç»„**ï¼Œä¹Ÿå°±æ˜¯è¯´æ•°ç»„çš„ä»»ä½•ä¸€ç‚¹éƒ½å¯èƒ½è¢«çœ‹ä½œèµ·ç‚¹æˆ–è€…ç»ˆç‚¹ã€‚`ArrayDeque`æ˜¯éçº¿ç¨‹å®‰å…¨çš„ï¼Œå½“å¤šä¸ªçº¿ç¨‹åŒæ—¶ä½¿ç”¨çš„æ—¶å€™ï¼Œéœ€è¦ç¨‹åºå‘˜æ‰‹åŠ¨åŒæ­¥ï¼›å¦å¤–ï¼Œè¯¥å®¹å™¨ä¸å…è®¸æ”¾å…¥`null`å…ƒç´ ã€‚

![ArrayDeque_base.png](https://pdai.tech/_images/collection/ArrayDeque_base.png)

> **`head`æŒ‡å‘é¦–ç«¯ç¬¬ä¸€ä¸ªæœ‰æ•ˆå…ƒç´ ï¼Œ`tail`æŒ‡å‘å°¾ç«¯ç¬¬ä¸€ä¸ªå¯ä»¥æ’å…¥å…ƒç´ çš„ç©ºä½**ã€‚å› ä¸ºæ˜¯å¾ªç¯æ•°ç»„ï¼Œæ‰€ä»¥`head`ä¸ä¸€å®šæ€»ç­‰äº0ï¼Œ`tail`ä¹Ÿä¸ä¸€å®šæ€»æ˜¯æ¯”`head`å¤§ã€‚



##### æ„é€ æ–¹æ³•

1. `ArrayDeque`çš„ç©ºå‚æ„é€ æ–¹æ³•é»˜è®¤åˆ›å»ºå¤§å°ä¸º16çš„æ•°ç»„

   ```java
   public ArrayDeque() {
       elements = new Object[16];
   }
   ```

2. `ArrayDeque`çš„å«å‚æ„é€ æ–¹æ³•éƒ½ä¼šå…ˆè°ƒç”¨ä¸€ä¸ª`calculateSize(int numElements)`æ–¹æ³•æ¥æ±‚å®é™…éœ€è¦åˆ›å»ºçš„æ•°ç»„å¤§å°

   - å¦‚æœ`numElements < MIN_INITIAL_CAPACITY`ï¼Œåˆ™è¯¥æ–¹æ³•ä¼šè¿”å›`MIN_INITIAL_CAPACITY`ï¼Œåˆ›å»ºä¸€ä¸ªé•¿åº¦ä¸º8çš„æ•°ç»„
   - å¦‚æœ`numsElements >= MIN_INITIAL_CAPACITY`ï¼Œåˆ™è¯¥æ–¹æ³•ä¼šè¿”å›å¤§äº`numsElements`çš„æœ€æ¥è¿‘çš„2çš„næ¬¡æ–¹

   ```java
   private static int calculateSize(int numElements) {
      // æœ€å°å®¹é‡ï¼Œä¸º8
       int initialCapacity = MIN_INITIAL_CAPACITY;
       // ç®—å‡ºå¤§äºnumElementsä¸”ä¸å°äº8çš„æœ€æ¥è¿‘çš„2çš„næ¬¡æ–¹
       if (numElements >= initialCapacity) {
           initialCapacity = numElements;
           initialCapacity |= (initialCapacity >>>  1);
           initialCapacity |= (initialCapacity >>>  2);
           initialCapacity |= (initialCapacity >>>  4);
           initialCapacity |= (initialCapacity >>>  8);
           initialCapacity |= (initialCapacity >>> 16);
           initialCapacity++;
   
           if (initialCapacity < 0)   // Too many elements, must back off
               initialCapacity >>>= 1;// Good luck allocating 2 ^ 30 elements
       }
      // å¦‚æœä¸€å¼€å§‹çš„initialCapacity>numElementsï¼Œå³è¦æ±‚åˆå§‹åŒ–çš„æ•°ç»„é•¿åº¦å°äº8ï¼Œåˆ™å®é™…ä¸Šåˆ›å»ºé•¿åº¦ä¸º8çš„æ•°ç»„ï¼ˆæœ€å°è¦æ±‚ï¼‰
       return initialCapacity;
   }
   ```



##### å…¥é˜Ÿ

1. `ArrayDeque`çš„å…¥é˜Ÿæœ‰ä¸¤ç§æ–¹æ³•ï¼šä»é˜Ÿå¤´å…¥é˜Ÿ`addFirst(E e)`å’Œä»é˜Ÿå°¾å…¥é˜Ÿ`addLast(E e)`ã€‚

2. ä½¿ç”¨å–ä½™æ¥è®¡ç®—æ–°å…ƒç´ çš„ä¸‹æ ‡ï¼Œ`x & (len - 1) = x % len`ï¼Œä½¿ç”¨&çš„æ–¹å¼æ›´å¿«ã€‚

   `addFirst`ä¸­`x=head-1`ï¼Œ`addLast`ä¸­`x=tail+1`

3. å¦‚æœå®¹é‡ä¸å¤Ÿäº†ï¼Œå°±æ‰©å¤§ä¸ºä¸¤å€



##### æ‰©å®¹

```java
private void doubleCapacity() {
 	 assert head == tail;
    // å¤´æŒ‡é’ˆçš„ä½ç½®
    int p = head;
    // æ—§æ•°ç»„é•¿åº¦
    int n = elements.length;
    // å¤´æŒ‡é’ˆç¦»æ•°ç»„å°¾çš„è·ç¦»
    int r = n - p; // number of elements to the right of p
    // æ–°é•¿åº¦ä¸ºæ—§é•¿åº¦çš„ä¸¤å€
    int newCapacity = n << 1;
    // åˆ¤æ–­æ˜¯å¦æº¢å‡º
    if (newCapacity < 0)
        throw new IllegalStateException("Sorry, deque too big");
    // æ–°å»ºæ–°æ•°ç»„
    Object[] a = new Object[newCapacity];
    // å°†æ—§æ•°ç»„headä¹‹åçš„å…ƒç´ æ‹·è´åˆ°æ–°æ•°ç»„ä¸­
    System.arraycopy(elements, p, a, 0, r);
    // å°†æ—§æ•°ç»„ä¸‹æ ‡0åˆ°headä¹‹é—´çš„å…ƒç´ æ‹·è´åˆ°æ–°æ•°ç»„ä¸­
    System.arraycopy(elements, 0, a, r, p);
    // èµ‹å€¼ä¸ºæ–°æ•°ç»„
    elements = a;
    // headæŒ‡å‘0ï¼ŒtailæŒ‡å‘æ—§æ•°ç»„é•¿åº¦è¡¨ç¤ºçš„ä½ç½®
    head = 0;
    tail = n;
}
```

![img](https://pic3.zhimg.com/80/v2-387f8054f0d552eccf6a077506c1d512_720w.jpg)



## HashMap

### å±æ€§åˆ†æ

```java
// é»˜è®¤çš„å®¹é‡å¤§å°ä¸º16ï¼ˆmapçš„å¤§å°éƒ½ä¼šåˆå§‹åŒ–ä¸º2çš„næ¬¡æ–¹ï¼‰
static final int DEFAULT_INITIAL_CAPACITY = 1 << 4; // aka 16

// æœ€å¤§çš„å®¹é‡ä¸º2^30
static final int MAXIMUM_CAPACITY = 1 << 30;

// é»˜è®¤çš„è´Ÿè½½å› å­ï¼Œå½“è£…è½½çš„æ•°æ®è¾¾åˆ°å®¹é‡çš„0.75å°±ä¼šè¿›è¡Œrehashæ‰©å®¹
static final float DEFAULT_LOAD_FACTOR = 0.75f;

// JDK8æ–°å¢ï¼Œé“¾è¡¨æ ‘åŒ–é˜ˆå€¼ï¼Œå½“æ¡¶ä¸­èŠ‚ç‚¹æ•°å¤§äºè¯¥é•¿åº¦æ—¶ï¼Œå°†é“¾è¡¨è½¬æˆçº¢é»‘æ ‘å­˜å‚¨
static final int TREEIFY_THRESHOLD = 8;

// JDK8æ–°å¢ï¼Œçº¢é»‘æ ‘é“¾åŒ–é˜ˆå€¼ï¼Œå½“åŒç§èŠ‚ç‚¹æ•°å°äºè¯¥é•¿åº¦ï¼Œå°†çº¢é»‘æ ‘è½¬æˆé“¾è¡¨å­˜å‚¨
static final int UNTREEIFY_THRESHOLD = 6;

// æœ€å°æ ‘åŒ–é˜ˆå€¼ï¼Œå½“æ¡¶ä¸­æ‰€æœ‰å€¼éƒ½è¶…è¿‡è¯¥å€¼æ—¶æ‰ä¼šè¿›è¡Œæ ‘åŒ–
static final int MIN_TREEIFY_CAPACITY = 64;

// å“ˆå¸Œæ¡¶æ•°ç»„ï¼Œå…¶é•¿åº¦ä¸€å®šæ˜¯2çš„næ¬¡æ–¹
transient Node<K,V>[] table;

//  æ•°æ®è½¬æ¢æˆsetçš„å¦ä¸€ç§å­˜å‚¨å½¢å¼ï¼Œä¸»è¦ç”¨äºè¿­ä»£
transient Set<Map.Entry<K,V>> entrySet;

// è®°å½•å½“å‰mapçš„å¤§å°
transient int size;

// ä¸ArrayListä¸­çš„ä½œç”¨ä¸€è‡´-å¿«å¤±è´¥æœºåˆ¶
transient int modCount;

// æ‰©å®¹é˜ˆå€¼ï¼Œå½“mapä¸­å­˜å‚¨çš„é”®å€¼å¯¹è¶…è¿‡è¯¥å€¼æ—¶å°±æ‰©å®¹ä¸ºåŸæ¥çš„ä¸¤å€
int threshold;

// å½“å‰çš„è´Ÿè½½å› å­ï¼Œå¯é€šè¿‡è¿™ä¸ªè®¡ç®—å‡ºæ‰©å®¹é˜ˆå€¼ï¼šthreshold = loadFactor * table.length
final float loadFactor;
```

1. `TREEIFY_THRESHOLD`ã€`UNTREEIFY_THRESHOLD`ã€`MIN_TREEIFY_CAPACITY`è¿™å‡ ä¸ªä¸çº¢é»‘æ ‘ç›¸å…³çš„ç±»å¸¸é‡ä¸ºJDK8æ–°å¢çš„ã€‚

   JDK7çš„`HashMap`åº•å±‚æ•°æ®ç»“æ„ä¸º**æ•°ç»„+é“¾è¡¨**ï¼ŒJDK8çš„åº•å±‚æ•°æ®ç»“æ„ä¸º**æ•°ç»„+é“¾è¡¨+çº¢é»‘æ ‘**ï¼Œåœ¨JDK7åŠä»¥å‰æ— è®ºæ•°æ®æœ‰å¤šå°‘ï¼Œä¸€ä¸ªæ¡¶ä¸­çš„æ•°æ®éƒ½æ˜¯ç”¨é“¾è¡¨æ¥å­˜å‚¨çš„ï¼Œæ‰€ä»¥å½“æ•°æ®é‡è¿‡å¤§æ—¶ï¼ŒèŠ±åœ¨å¯»æ‰¾æ•°æ®ï¼ˆéå†é“¾è¡¨ï¼‰çš„æ—¶é—´å°±éå¸¸å¤§

2. è´Ÿè½½å› å­=0.75ï¼šåœ¨ç†æƒ³æƒ…å†µä¸‹ï¼Œä½¿ç”¨éšæœºå“ˆå¸Œå—ï¼ŒèŠ‚ç‚¹å‡ºç°çš„é¢‘ç‡åœ¨`hash`æ¡¶ä¸­éµå¾ªæ³Šæ¾åˆ†å¸ƒã€‚è´Ÿè½½å› å­ä¸º0.75æ—¶ï¼Œæ¡¶ä¸­å…ƒç´ è¾¾åˆ°8ä¸ªçš„æ¦‚ç‡ä¸º0.00000006ï¼Œä¹Ÿå°±æ˜¯è¯´æ¯ä¸ªç¢°æ’ä½ç½®çš„é“¾è¡¨é•¿åº¦è¶…è¿‡8ä¸ªæ˜¯å‡ ä¹ä¸å¯èƒ½çš„ã€‚ï¼ˆå› ä¸ºç”±é“¾è¡¨è½¬æ¢æˆçº¢é»‘æ ‘çš„æ“ä½œæ˜¯ååˆ†è€—è´¹æ€§èƒ½çš„ï¼Œæ‰€ä»¥è¦åœ¨ä¿è¯`HashMap`æŸ¥è¯¢æ•ˆç‡çš„åŒæ—¶å°½å¯èƒ½å‡å°‘æ ‘åŒ–çš„æ¦‚ç‡ï¼‰

3. ä¸ºä»€ä¹ˆ`HashMap`çš„å®¹é‡ä¸€å®šè¦æ˜¯2çš„å¹‚ï¼Ÿ

   `HashMap` é‡‡ç”¨è¿™ç§éå¸¸è§„è®¾è®¡ï¼Œä¸»è¦æ˜¯**ä¸ºäº†åœ¨å–æ¨¡å’Œæ‰©å®¹æ—¶åšä¼˜åŒ–ï¼ŒåŒæ—¶ä¸ºäº†å‡å°‘hashç¢°æ’**ï¼Œ`HashMap` å®šä½å“ˆå¸Œæ¡¶ç´¢å¼•ä½ç½®æ—¶ï¼Œä¹ŸåŠ å…¥äº†é«˜ä½å‚ä¸è¿ç®—çš„è¿‡ç¨‹ã€‚

   é•¿åº¦16æˆ–è€…å…¶ä»–2çš„å¹‚ï¼Œ`Length-1`çš„å€¼æ˜¯æ‰€æœ‰äºŒè¿›åˆ¶ä½å…¨ä¸º1ï¼Œè¿™ç§æƒ…å†µä¸‹ï¼Œ`index`çš„ç»“æœç­‰åŒäº`HashCode`åå‡ ä½çš„å€¼ã€‚åªè¦è¾“å…¥çš„`HashCode`æœ¬èº«åˆ†å¸ƒå‡åŒ€ï¼Œ`Hash`ç®—æ³•çš„ç»“æœå°±æ˜¯å‡åŒ€çš„ã€‚

   å¦‚æœä¸ä¸º16æˆ–è€…2çš„å¹‚ï¼Œé‚£ä¹ˆï¼Œç»è¿‡`hash`ç®—æ³•ä¹‹åï¼Œæœ‰äº›`index`ç»“æœå‡ºç°çš„æ¦‚ç‡ä¼šæ›´å¤§ï¼Œè€Œæœ‰äº›`index`åˆ™æ°¸è¿œæ­¥ä¼šå‡ºç°ã€‚å³ä¸ç¬¦åˆ`hash`ç®—æ³•çš„jå‡åŒ€åˆ†å¸ƒçš„åŸåˆ™ã€‚



### ç¡®å®šå“ˆå¸Œæ¡¶æ•°ç»„ç´¢å¼•ä½ç½®-hash

```java
//ç»è¿‡ä¸¤æ­¥æ“ä½œæœ€åå¾—åˆ°çš„æ‰æ˜¯æˆ‘ä»¬ç”¨æ¥ç¡®å®šä½ç½®çš„hashå€¼
    static final int hash(Object key) {
        int h;
        // h = key.hashCode() ä¸ºç¬¬ä¸€æ­¥ å–hashCodeå€¼
        // h ^ (h >>> 16)  ä¸ºç¬¬äºŒæ­¥ é«˜ä½å‚ä¸è¿ç®—
        return (key == null) ? 0 : (h = key.hashCode()) ^ (h >>> 16);
    }
//ç¡®å®šhashå€¼ä¹‹åçš„æ“ä½œå°±æ˜¯ç¡®å®šåœ¨å“ˆå¸Œæ¡¶ä¸­çš„ä½ç½®äº†
//ä¸‹é¢æ˜¯ put() æ–¹æ³•ä¸­çš„ä¸€è¡Œä»£ç ï¼Œnä¸ºå“ˆå¸Œæ¡¶æ•°ç»„é•¿åº¦ï¼Œhashä¸ºå‰ä¸€æ­¥ç¡®å®šçš„hashå€¼
// ç›¸å½“äºå–ä½™ï¼Œåªä¸è¿‡ä½ä¸è¿ç®—çš„é€Ÿåº¦æ›´å¿«
    p = tab[i = (n - 1) & hash]
```

![img](https://upload-images.jianshu.io/upload_images/18499914-08b5602de447673d.png?imageMogr2/auto-orient/strip|imageView2/2/w/720/format/webp)



### æ‰©å®¹resize

```java
final Node<K,V>[] resize() {
        Node<K,V>[] oldTab = table;
        int oldCap = (oldTab == null) ? 0 : oldTab.length;
        int oldThr = threshold;
        int newCap, newThr = 0;
        //ç¬¬ä¸€éƒ¨åˆ†ï¼šæ’é™¤å¼‚å¸¸æƒ…å†µï¼Œæ‰©å®¹
        if (oldCap > 0) {
           // å¦‚æœHashMapçš„å®¹é‡å·²ç»åˆ°è¾¾æœ€å¤§å®¹é‡äº†ï¼Œä¸ä¼šå†åº“å®¹
            if (oldCap >= MAXIMUM_CAPACITY) {
               // å¢å¤§æ‰©å®¹é˜ˆå€¼ï¼Œä¿è¯ä¹‹ååŸºæœ¬éƒ½ä¸ä¼šå†å°è¯•è¿›è¡Œæ‰©å®¹äº†
                threshold = Integer.MAX_VALUE;
                return oldTab;
            }
          // å¦‚æœæ‰©å¤§åˆ°ä¸¤å€åæ²¡æœ‰æº¢å‡ºä¸”å¤§äºé»˜è®¤çš„åˆå§‹åŒ–å®¹é‡
            else if ((newCap = oldCap << 1) < MAXIMUM_CAPACITY &&
                     oldCap >= DEFAULT_INITIAL_CAPACITY)
               // æ–°çš„æ‰©å®¹é˜ˆå€¼ä¸ºåŸæ¥çš„ä¸¤å€
                newThr = oldThr << 1; // double threshold
        }
        //ç¬¬äºŒéƒ¨åˆ†ï¼šè®¾ç½®é˜ˆå€¼
        else if (oldThr > 0) // initial capacity was placed in threshold
           // å¦‚æœåŸæ¥çš„thredsholdå¤§äº0åˆ™å°†å®¹é‡è®¾ä¸ºåŸæ¥çš„thredshold
			// åœ¨ç¬¬ä¸€æ¬¡å¸¦å‚æ•°åˆå§‹åŒ–æ—¶å€™ä¼šæœ‰è¿™ç§æƒ…å†µ
            newCap = oldThr;
        else {               // zero initial threshold signifies using defaults
          // åœ¨é»˜è®¤æ— å‚æ•°åˆå§‹åŒ–ä¼šæœ‰è¿™ç§æƒ…å†µ
           // é»˜è®¤åˆå§‹åŒ–æœ€å°å®¹é‡ä¸º16
            newCap = DEFAULT_INITIAL_CAPACITY;
           // æ‰©å®¹é˜ˆå€¼=è´Ÿè½½å› å­*å®¹é‡=12
            newThr = (int)(DEFAULT_LOAD_FACTOR * DEFAULT_INITIAL_CAPACITY);
        }
  		// åˆå§‹åŒ–æ–°çš„æ‰©å®¹é˜ˆå€¼
        if (newThr == 0) {
            float ft = (float)newCap * loadFactor;
            newThr = (newCap < MAXIMUM_CAPACITY && ft < (float)MAXIMUM_CAPACITY ?
                      (int)ft : Integer.MAX_VALUE);
        }
        threshold = newThr;
  
// ç¬¬ä¸‰éƒ¨åˆ†ï¼šç§»åŠ¨æ•°æ®åˆ°æ–°mapä¸­
```

![image-20211119215033509](https://tva1.sinaimg.cn/large/008i3skNgy1gwksscftukj31b20tajxy.jpg)

```java
// ç¬¬ä¸‰éƒ¨åˆ†ï¼šç§»åŠ¨æ•°æ®åˆ°æ–°mapä¸­  
@SuppressWarnings({"rawtypes","unchecked"})
    Node<K,V>[] newTab = (Node<K,V>[])new Node[newCap];
    table = newTab;
    //ç¬¬ä¸‰éƒ¨åˆ†ï¼šæ—§æ•°æ®ä¿å­˜åœ¨æ–°æ•°ç»„é‡Œé¢
    if (oldTab != null) {
        //éå†æ—§æ•°ç»„
        for (int j = 0; j < oldCap; ++j) {
            Node<K,V> e;
            if ((e = oldTab[j]) != null) {
                oldTab[j] = null;
                 // å¦‚æœæ²¡æœ‰åç»­èŠ‚ç‚¹ï¼Œåˆ™ç”¨å–ä½™æ“ä½œæ¥ç¡®å®šç´¢å¼•ä½ç½®
                if (e.next == null)
                    newTab[e.hash & (newCap - 1)] = e;
                //å¦‚æœæ˜¯çº¢é»‘æ ‘ï¼Œéœ€è¦è¿›è¡Œæ ‘æ‹†åˆ†ç„¶åæ˜ å°„
                else if (e instanceof TreeNode)
                    ((TreeNode<K,V>)e).split(this, newTab, j, oldCap);
                // å¦‚æœæ˜¯å¤šä¸ªèŠ‚ç‚¹çš„é“¾è¡¨ï¼Œå°†åŸé“¾è¡¨æ‹†åˆ†ä¸ºä¸¤ä¸ªé“¾è¡¨
                else { // preserve order
                   // æ•°ç»„ä½ä½çš„å¤´å’Œå°¾
                    Node<K,V> loHead = null, loTail = null;
                   // æ•°ç»„é«˜ä½çš„å¤´å’Œå°¾
                    Node<K,V> hiHead = null, hiTail = null;
                    Node<K,V> next;
                    do {
                        next = e.next;
                        // å¦‚æœe.hash & oldCap == 0åˆ™å½“å‰èŠ‚ç‚¹ä¸éœ€è¦ç§»ä½ï¼Œç›´æ¥æ˜ å°„åˆ°æ–°æ•°ç»„å¯¹åº”ç›¸åŒç´¢å¼•çš„ä½ç½®
                        if ((e.hash & oldCap) == 0) {
                            if (loTail == null)
                                loHead = e;
                            else
                                loTail.next = e;
                            loTail = e;
                        } 
                        // åŸç´¢å¼• + oldCap
                        else {
                            if (hiTail == null)
                                hiHead = e;
                            else
                                hiTail.next = e;
                            hiTail = e;
                        }
                    } while ((e = next) != null);
                  
                    // éå†å®Œæ¡¶ä¸­æ‰€æœ‰èŠ‚ç‚¹åæ‰æŠŠæ‹†åˆ†å®Œæˆçš„ä¸¤ä¸ªé“¾è¡¨å…³è”åˆ°æ–°è¡¨ä¸­
                     // é“¾è¡¨1å­˜äºåŸç´¢å¼•
                    if (loTail != null) {
                        loTail.next = null;
                        newTab[j] = loHead;
                    }
                    // é“¾è¡¨2å­˜äºåŸç´¢å¼•åŠ ä¸ŠåŸhashæ¡¶é•¿åº¦çš„åç§»é‡
                    if (hiTail != null) {
                        hiTail.next = null;
                        newTab[j + oldCap] = hiHead;
                    }
                }
            }
        }
    }
    return newTab;
```

![image-20211120104920633](https://tva1.sinaimg.cn/large/008i3skNgy1gwlfamlc0wj30u00w7jvz.jpg)

![img](https://pic4.zhimg.com/80/v2-3b60c7eae5642485e9a7fa2943aa753b_720w.jpg)



**e.hash & oldCap == 0ä¸ºä»€ä¹ˆå¯ä»¥åˆ¤æ–­å½“å‰èŠ‚ç‚¹æ˜¯å¦éœ€è¦ç§»ä½, è€Œä¸æ˜¯å†æ¬¡è®¡ç®—hash**

ä»ç„¶æ˜¯åŸå§‹é•¿åº¦ä¸º16ä¸¾ä¾‹:

```text
 old:
 10: 0000 1010
 oldCap-1=16-1=15: 0000 1111
 &: 000[0] 1010 
 
 new:
 10: 0000 1010
newCap-1=16*2-1= 31: 0001 1111
 &: 000[1] 1010 
```

ä»ä¸Šé¢çš„ç¤ºä¾‹å¯ä»¥å¾ˆè½»æ˜“çš„çœ‹å‡º, ä¸¤æ¬¡`indexFor()`çš„å·®åˆ«åªæ˜¯ç¬¬äºŒæ¬¡å‚ä¸ä½äºæ¯”ç¬¬ä¸€æ¬¡å·¦è¾¹æœ‰ä¸€ä½ä»0å˜ä¸º1, è€Œè¿™ä¸ªå˜åŒ–çš„1åˆšå¥½æ˜¯`oldCap`, é‚£ä¹ˆåªéœ€è¦åˆ¤æ–­åŸ`key`çš„`hash`è¿™ä¸ªä½ä¸Šæ˜¯å¦ä¸º1: è‹¥æ˜¯1, åˆ™éœ€è¦ç§»åŠ¨è‡³`oldCap + i`çš„æ§½ä½, è‹¥ä¸º0, åˆ™ä¸éœ€è¦ç§»åŠ¨;

è¿™ä¹Ÿæ˜¯`HashMap`çš„é•¿åº¦å¿…é¡»ä¿è¯æ˜¯2çš„å€æ•°çš„åŸå› , æ­£å› ä¸ºè¿™ç§ç¯ç¯ç›¸æ‰£çš„è®¾è®¡, `HashMap.loadFactor`çš„é€‰å€¼æ˜¯3/4ï¼ˆ0.75ï¼‰å°±èƒ½ç†è§£äº†, `table.length * 3/4`å¯ä»¥è¢«ä¼˜åŒ–ä¸º`(table.length >> 2) << 2) - (table.length >> 2) == table.length - (table.lenght >> 2)`, ï¼ˆä¹˜é™¤è¿ç®—ä¼˜åŒ–ä¸ºä½è¿ç®—ï¼‰JAVAçš„ä½è¿ç®—æ¯”ä¹˜é™¤çš„æ•ˆç‡æ›´é«˜, æ‰€ä»¥å–3/4åœ¨ä¿è¯`hash`å†²çªå°çš„æƒ…å†µä¸‹å…¼é¡¾äº†æ•ˆç‡;



#### JDK7ä¸­çš„resizeæ­»å¾ªç¯é—®é¢˜

åœ¨JDK1.7åŠä»¥å‰çš„ç‰ˆæœ¬ï¼Œå¦‚æœåœ¨å¹¶å‘ç¯å¢ƒä¸­ä½¿ç”¨`HashMap`ä¿å­˜æ•°æ®ï¼Œæœ‰å¯èƒ½ä¼šäº§ç”Ÿä¸¤ä¸ªé—®é¢˜ï¼šæ­»å¾ªç¯å’Œæ•°æ®ä¸¢å¤±ã€‚

äº§ç”Ÿæ­»å¾ªç¯é—®é¢˜æ˜¯å› ä¸ºJDK1.7åŠä»¥å‰çš„ç‰ˆæœ¬ä¸­ï¼Œ`HashMap`æ‰©å®¹é‡‡ç”¨çš„æ˜¯å¤´æ’å…¥ï¼ˆå¯¼è‡´ç»“ç‚¹é¡ºåºå¯èƒ½ä¼šé¢ å€’ï¼‰ï¼Œ1.8åšçš„æ”¹è¿›æ˜¯é‡‡ç”¨å°¾æ’æ³•ï¼Œæ‰€ä»¥ä¸ä¼šé€ æˆæ­»å¾ªç¯çš„é—®é¢˜ï¼Œä½†æ˜¯ä»ç„¶æ— æ³•è§£å†³æ•°æ®ä¸¢å¤±é—®é¢˜ï¼Œæ‰€ä»¥JDK8ä¸­çš„`HashMap`ä»ç„¶æ˜¯çº¿ç¨‹ä¸å®‰å…¨çš„ã€‚

ä¸‹é¢æ˜¯JDK7ä¸­æ‰©å®¹æ—¶å¯èƒ½ä¼šäº§ç”Ÿæ­»å¾ªç¯é—®é¢˜çš„éƒ¨åˆ†ä»£ç 

```java
void transfer(Entry[] newTable, boolean rehash) {
        int newCapacity = newTable.length;
        for (Entry<K,V> e : table) {
            while(null != e) {
               // æš‚å­˜èŠ‚ç‚¹eåŸæ¥çš„ä¸‹ä¸€ä¸ªç»“ç‚¹
                Entry<K,V> next = e.next;     
               // é‡æ–°è®¡ç®—åœ¨æ–°è¡¨ä¸­çš„hashå€¼
                if (rehash) {
                    e.hash = null == e.key ? 0 : hash(e.key);
                }
                int i = indexFor(e.hash, newCapacity);
               // èŠ‚ç‚¹eçš„ä¸‹ä¸€ä¸ªç»“ç‚¹æŒ‡å‘æ–°æ•°ç»„ä¸­å¯¹åº”é“¾è¡¨çš„å¤´ç»“ç‚¹ï¼ˆå¤´æ’ï¼‰
                e.next = newTable[i];
               // æ›´æ–°æ–°æ•°ç»„ä¸­å­˜å‚¨çš„å¤´ç»“ç‚¹ä¸ºe
                newTable[i] = e;
               // éå†ä¸‹ä¸€ä¸ªç»“ç‚¹
                e = next;
            }
        }
    }
```

ä¸‹é¢è¿˜åŸä¸€ä¸‹JDK7ä¸­æ­»å¾ªç¯é—®é¢˜çš„äº§ç”Ÿè¿‡ç¨‹

1. æ‰©å®¹å‰çš„HashMapå¦‚ä¸‹

   ![image-20211120112741856](https://tva1.sinaimg.cn/large/008i3skNgy1gwlgej2pwuj30m80d6750.jpg)

2. å½“è¯•å›¾æ’å…¥ç¬¬å››ä¸ªèŠ‚ç‚¹æ—¶ï¼Œç”±äºå·²ç»è¾¾åˆ°æ‰©å®¹é˜ˆå€¼ï¼Œæ‰€ä»¥ä¼šè¿›è¡Œæ‰©å®¹æ“ä½œ

   ![image-20211120112848823](https://tva1.sinaimg.cn/large/008i3skNgy1gwlgfotgi1j30ok0iedh3.jpg)

   ![image-20211120112939272](https://tva1.sinaimg.cn/large/008i3skNgy1gwlggk7dcsj30ng0igmyd.jpg)

   ![image-20211120113033655](https://tva1.sinaimg.cn/large/008i3skNgy1gwlghigj7vj30ju0hswfi.jpg)

   å¯ä»¥çœ‹åˆ°æ‰©å®¹ç»“æŸåabç»“ç‚¹çš„é¡ºåºè°ƒæ¢äº†

3. ç¬¬äºŒç‚¹ä¸­çš„æ‰©å®¹åœ¨å•çº¿ç¨‹ç¯å¢ƒä¸­æ˜¯æ²¡æœ‰é—®é¢˜çš„ï¼Œä½†å¦‚æœæ˜¯åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹å‘¢ï¼Ÿ

   å‡è®¾çº¿ç¨‹1å’Œçº¿ç¨‹2éƒ½è¦è¿›è¡Œæ‰©å®¹æ“ä½œï¼Œçº¿ç¨‹2è·å–åˆ°åŸæ¥çš„aèŠ‚ç‚¹åï¼Œç”±çº¿ç¨‹1å®Œæˆäº†æ•´ä¸ªæ‰©å®¹æ“ä½œã€‚

   çº¿ç¨‹1å®Œæˆåçº¿ç¨‹2ä¼šç»§ç»­è¿›è¡Œæ‰©å®¹ã€‚

   ï¼ˆ1ï¼‰çº¿ç¨‹äºŒå¼€å§‹æ‰§è¡Œ, è·å–AèŠ‚ç‚¹çš„`next`èŠ‚ç‚¹, `a.next = null`;

   ï¼ˆ2ï¼‰ æ¥ç€æ‰§è¡Œ `a.next = newTable[i]`; å› ä¸ºè¿™æ—¶å€™`newTable[i]`å·²ç»æ˜¯BèŠ‚ç‚¹äº†, å¹¶ä¸”`b.next = a`; é‚£ä¹ˆæˆ‘ä»¬æŠŠ`newTable[i]`èµ‹å€¼ç»™`a.next`å, å°±ä¼šçº¿ç¨‹`a-b-a`è¿™æ ·çš„ç¯å½¢é“¾è¡¨äº†

   ï¼ˆ3ï¼‰ å› ä¸ºç¬¬ä¸‰æ­¥çš„`a.next`å·²ç»æ˜¯`null`, æ‰€ä»¥CèŠ‚ç‚¹å°±ä¸¢å¤±äº†

   ï¼ˆ4ï¼‰ ä¹‹åå¦‚æœæƒ³è¦æŸ¥æ‰¾ä½äºæ¡¶1ä¸­çš„æ•°æ®æ—¶å°±ä¼šé™·å…¥æ­»å¾ªç¯äº†

   ![image-20211120114128522](https://tva1.sinaimg.cn/large/008i3skNgy1gwlgsv6clyj30h40hmdgm.jpg)



**JDK8çš„æ”¹è¿›ï¼š**

1. JDK8ä½¿ç”¨å°¾æ’æ³•ï¼Œæ‰€ä»¥ä¸ä¼šæ”¹å˜ç»“ç‚¹çš„é¡ºåºï¼Œå°±ä¸ä¼šäº§ç”Ÿå€’æ’é—®é¢˜
2. è€Œä¸”JDK8æ˜¯åœ¨éå†å®Œæ‰€æœ‰èŠ‚ç‚¹ä¹‹å, æ‰å¯¹å½¢æˆçš„ä¸¤ä¸ªé“¾è¡¨è¿›è¡Œå…³è”`table`çš„, æ‰€ä»¥ä¸ä¼šåƒJAVA7ä¸€èˆ¬å½¢æˆA-B-Aé—®é¢˜äº†
3. ä½†æ˜¯å¦‚æœå¹¶å‘äº†, JAVAçš„`HashMap`è¿˜æ˜¯æ²¡æœ‰è§£å†³ä¸¢æ•°æ®çš„é—®é¢˜, ä½†æ˜¯ä¸å’ŒJAVA7ä¸€èˆ¬æœ‰æ•°æ®å€’æ’ä»¥åŠæ­»å¾ªç¯çš„é—®é¢˜äº†



### put

```java
final V putVal(int hash, K key, V value, boolean onlyIfAbsent,
               boolean evict) {
    Node<K,V>[] tab; Node<K,V> p; int n, i;
   // è¡¨ä¸ºç©ºï¼Œè¿›è¡Œæ‰©å®¹æ“ä½œ
    if ((tab = table) == null || (n = tab.length) == 0)
        n = (tab = resize()).length;
   // å¯¹åº”çš„æ¡¶ä¸­æ²¡æœ‰æ•°æ®ï¼Œç›´æ¥ä½œä¸ºå¤´ç»“ç‚¹æ”¾åˆ°æ¡¶ä¸­ï¼ˆå…¶å®å°±æ˜¯æ²¡æœ‰å‘ç”Ÿç¢°æ’ï¼‰
    if ((p = tab[i = (n - 1) & hash]) == null)
        tab[i] = newNode(hash, key, value, null);
  
    // æŠŠæ–°èŠ‚ç‚¹æ’å…¥åˆ°é“¾è¡¨æˆ–æ ‘ä¸­
    else {
        Node<K,V> e; K k;
       // åˆ¤æ–­æ˜¯å¦ä¼ å…¥åŒä¸€ä¸ªkey
        if (p.hash == hash &&
            ((k = p.key) == key || (key != null && key.equals(k))))
            e = p;
       // ä¼ å…¥æ–°çš„key
       // æ’å…¥åˆ°çº¢é»‘æ ‘ä¸­
        else if (p instanceof TreeNode)
            e = ((TreeNode<K,V>)p).putTreeVal(this, tab, hash, key, value);
       // æ’å…¥åˆ°é“¾è¡¨ä¸­
        else {
            for (int binCount = 0; ; ++binCount) {
               // å¦‚æœæ²¡æœ‰åç»­ç»“ç‚¹
                if ((e = p.next) == null) {
                   // æ’å…¥åˆ°é“¾è¡¨çš„æœ€å
                    p.next = newNode(hash, key, value, null);
                   // æ ‘åŒ–
                    if (binCount >= TREEIFY_THRESHOLD - 1) // -1 for 1st
                        treeifyBin(tab, hash);
                    break;
                }
              // ä½¿ç”¨hashå€¼ã€å†…å­˜ã€equalsåŒæ—¶åˆ¤æ–­keyä¸ç»“ç‚¹eçš„keyæ˜¯å¦ç›¸åŒ
                if (e.hash == hash &&
                    ((k = e.key) == key || (key != null && key.equals(k))))
                    break;
                p = e;
            }
        }
      
      // å¦‚æœè¯¥keyå·²ç»å­˜åœ¨äºmapä¸­ï¼Œåˆ™è¿›è¡Œæ›¿æ¢å¹¶è¿”å›æ—§å€¼
        if (e != null) { // existing mapping for key
            V oldValue = e.value;
            if (!onlyIfAbsent || oldValue == null)
                e.value = value;
            afterNodeAccess(e);
            return oldValue;
        }
    }
  // ç”¨äºå¿«å¤±è´¥æœºåˆ¶
    ++modCount;
  // å¦‚æœå·²ç»è¾¾åˆ°æ‰©å®¹é˜ˆå€¼ï¼Œåˆ™è°ƒç”¨resizeè¿›è¡Œæ‰©å®¹
    if (++size > threshold)
        resize();
    afterNodeInsertion(evict);
    return null;
}
```

![image-20211120150927434](https://tva1.sinaimg.cn/large/008i3skNgy1gwlmta9z0sj30u011ddll.jpg)



### LinkedHashMap

`LinkedHashMap`æ˜¯`HashMap`çš„ç›´æ¥å­ç±»ï¼Œä¸¤è€…å”¯ä¸€çš„åŒºåˆ«æ˜¯`LinkedHashMap`åœ¨`HashMap`çš„åŸºç¡€ä¸Šï¼Œé‡‡ç”¨åŒå‘é“¾è¡¨çš„å½¢å¼å°†æ‰€æœ‰`entry`è¿æ¥èµ·æ¥ï¼Œä»è€Œä¿è¯äº†å…ƒç´ çš„è¿­ä»£é¡ºåºå’Œæ’å…¥é¡ºåºç›¸åŒï¼Œå³åœ¨`HashMap`çš„åŸºç¡€ä¸Šå®ç°äº†æ•°æ®æœ‰åºã€‚



## HashSet

`HashSet`æ˜¯å¯¹`HashMap`çš„ç®€å•åŒ…è£…ï¼Œåˆ©ç”¨`HashMap`é”®ä¸å¯é‡å¤ä¸”æ— éœ€çš„ç‰¹æ€§æ¥å®ç°`HashSet`çš„æ— åºä¸é‡å¤çš„åŠŸèƒ½



## WeekHashMap

`WeekHashMap`é‡Œçš„`Entry`å¯èƒ½ä¼šè¢«GCè‡ªåŠ¨å›æ”¶ï¼Œå³ä½¿ç¨‹åºå‘˜æ²¡æœ‰æ‰‹åŠ¨è°ƒç”¨`remove()`æˆ–è€…`clear()`æ–¹æ³•

`WeakHashMap`çš„è¿™ä¸ªç‰¹ç‚¹ç‰¹åˆ«é€‚ç”¨äºéœ€è¦ç¼“å­˜çš„åœºæ™¯ã€‚åœ¨ç¼“å­˜åœºæ™¯ä¸‹ï¼Œç”±äºå†…å­˜æ˜¯æœ‰é™çš„ï¼Œä¸èƒ½ç¼“å­˜æ‰€æœ‰å¯¹è±¡ï¼›å¯¹è±¡ç¼“å­˜å‘½ä¸­å¯ä»¥æé«˜ç³»ç»Ÿæ•ˆç‡ï¼Œä½†ç¼“å­˜MISSä¹Ÿä¸ä¼šé€ æˆé”™è¯¯ï¼Œå› ä¸ºå¯ä»¥é€šè¿‡è®¡ç®—é‡æ–°å¾—åˆ°ã€‚

è¦æ˜ç™½ `WeakHashMap`çš„å·¥ä½œåŸç†ï¼Œè¿˜éœ€è¦å¼•å…¥ä¸€ä¸ªæ¦‚å¿µ : **å¼±å¼•ç”¨(WeakReference)**ã€‚

æˆ‘ä»¬éƒ½çŸ¥é“Javaä¸­å†…å­˜æ˜¯é€šè¿‡GCè‡ªåŠ¨ç®¡ç†çš„ï¼ŒGCä¼šåœ¨ç¨‹åºè¿è¡Œè¿‡ç¨‹ä¸­è‡ªåŠ¨åˆ¤æ–­å“ªäº›å¯¹è±¡æ˜¯å¯ä»¥è¢«å›æ”¶çš„ï¼Œå¹¶åœ¨åˆé€‚çš„æ—¶æœºè¿›è¡Œå†…å­˜é‡Šæ”¾ã€‚GCåˆ¤æ–­æŸä¸ªå¯¹è±¡æ˜¯å¦å¯è¢«å›æ”¶çš„ä¾æ®æ˜¯ï¼Œ**æ˜¯å¦æœ‰æœ‰æ•ˆçš„å¼•ç”¨æŒ‡å‘è¯¥å¯¹è±¡**ã€‚å¦‚æœæ²¡æœ‰æœ‰æ•ˆå¼•ç”¨æŒ‡å‘è¯¥å¯¹è±¡(åŸºæœ¬æ„å‘³ç€ä¸å­˜åœ¨è®¿é—®è¯¥å¯¹è±¡çš„æ–¹å¼)ï¼Œé‚£ä¹ˆè¯¥å¯¹è±¡å°±æ˜¯å¯å›æ”¶çš„ã€‚è¿™é‡Œçš„**æœ‰æ•ˆå¼•ç”¨** å¹¶ä¸åŒ…æ‹¬**å¼±å¼•ç”¨**ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œ**è™½ç„¶å¼±å¼•ç”¨å¯ä»¥ç”¨æ¥è®¿é—®å¯¹è±¡ï¼Œä½†è¿›è¡Œåƒåœ¾å›æ”¶æ—¶å¼±å¼•ç”¨å¹¶ä¸ä¼šè¢«è€ƒè™‘åœ¨å†…ï¼Œä»…æœ‰å¼±å¼•ç”¨æŒ‡å‘çš„å¯¹è±¡ä»ç„¶ä¼šè¢«GCå›æ”¶**ã€‚

`WeakHashMap` å†…éƒ¨æ˜¯é€šè¿‡å¼±å¼•ç”¨æ¥ç®¡ç†`entry`çš„ï¼Œå¼±å¼•ç”¨çš„ç‰¹æ€§å¯¹åº”åˆ° `WeakHashMap` ä¸Šæ„å‘³ç€ä»€ä¹ˆå‘¢ï¼Ÿ**å°†ä¸€å¯¹`key, value`æ”¾å…¥åˆ° `WeakHashMap` é‡Œå¹¶ä¸èƒ½é¿å…è¯¥`key`å€¼è¢«GCå›æ”¶ï¼Œé™¤éåœ¨WeakHashMapä¹‹å¤–è¿˜æœ‰å¯¹è¯¥`key`çš„å¼ºå¼•ç”¨**ã€‚

